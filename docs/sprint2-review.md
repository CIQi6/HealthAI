# Sprint 2 方案评审纪要

## 结论摘要
- Refresh Token、审计日志、秘钥管理三项能力与安全上线目标一致，但需按照“每个 Sprint 交付基础功能”的节奏分阶段落地。
- Sprint 2 聚焦最小可行增强：Refresh Token 基础能力 + 审计主流程埋点 + 生产秘钥加载流程雏形；高级查询、告警与自动轮换安排在 Sprint 3+。
- 现有方案结构完整，无需大幅调整；需细化任务拆解、验收标准与运维协作节点。
- 执行计划已拟定，实际开发将按优先级顺延开展，确保当前迭代优先完成基础交付能力。
- 截至 `2025-10-28`：Refresh Token 与审计埋点功能已合并主干，秘钥管理 Stub 实装，剩余工作聚焦文档、运维与查询 API。

## 重点调整与优先级
- **P0（Sprint 2 必达）**
  - `AuthService` 支持 Refresh Token 颁发/刷新/注销，Redis 持久化，核心集成测试覆盖。
  - `AuditTrailService` 最小实现，记录认证与健康档案的成功/失败事件，数据入库 MySQL。
  - 秘钥加载接口支持本地配置 + 生产 Secret Manager 协商的占位实现（stub），提供失败阻断机制。
- **P1（Sprint 2 可选/拉通测试后落地）**
  - 审计日志查询 API 雏形（仅管理员可用，分页查看）。
  - Refresh Token 黑名单与批量失效管理工具。
- **状态更新**：P0 已完成功能交付并通过 `AuthControllerTest` 验证；P1 中审计查询与批量失效工具仍处于需求澄清阶段。
- **P2（Sprint 3+ 规划）**
  - 审计日志异步化（Kafka）、可视化仪表盘。
  - 秘钥自动轮换与多秘钥兼容策略上线。

## Sprint 2 任务拆解
- **开发**
  - 设计并实现 `RefreshTokenService`、Redis 配置与异常编码。
  - 扩展 `JwtProvider`、`AuthController`、`AuthService`，完成登录/刷新/登出流程。
  - 建立 `AuditEvent` 实体、Mapper、Service，并在关键服务中埋点。
  - 实现 `SecretManagerClient` 接口及本地/占位实现，整合到应用启动流程。
- **测试**
  - 编写 MockMvc/集成测试：登录刷新成功、过期/无效刷新、登出失效。
  - 验证审计事件落库与关键字段完整性。
  - 编写秘钥加载失败用例，确认启动阻断与日志输出。
- **运维协作**
  - 与运维确认目标 Secret 管理服务（KMS/Secrets Manager/Vault）。
  - 约定秘钥注入流程、权限策略与轮换频率。
  - 评估 Redis 可用性与备份策略，确认部署拓扑。

## 运维对接事项
- 会议目标：确定秘钥服务选型、访问凭证管理、轮换责任人。
- 需准备材料：`SecretManagerClient` 接口说明、秘钥存储需求、失败告警需求。
- 输出物：运维 Runbook 草案、接入时间表、测试环境演练计划。

## 风险与缓解
- **Redis 可用性**：若部署延迟，需临时使用数据库存储 Refresh Token；Sprint 2 内需做决策。
- **审计数据量增长**：短期采用限量存储 + 归档策略；计划在 Sprint 3 引入分区或归档任务。
- **秘钥对接进度**：若运维侧选型落后，应用需准备手动注入 fallback，同时记录上线依赖项。

## 后续动作
- 组织设计评审会议，确认本纪要与 `docs/sprint2-plan.md` 的一致性。
- 在 Sprint 2 计划中创建 P0/P1 任务卡片，明确负责人与验收标准。
- 拉通运维沟通，产出秘钥管理对接会议纪要与 Runbook 草稿。
